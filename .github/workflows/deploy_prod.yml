name: Build and Deploy Production
on:
  push:
    branches:
      - release/*
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Install and Build 🔧
        env:
          CV_PARTNER_AUTHORIZATION: ${{ secrets.CV_PARTNER_AUTHORIZATION }}
          CV_PARTNER_URL: ${{ secrets.CV_PARTNER_URL }}
        run: |
          yarn
          yarn build:static

      - name: Create .nojekyll and CNAME in /out ✨
        run: |
          touch out/.nojekyll
          touch out/CNAME
          echo ${{ secrets.DEPLOY_URL }} > out/CNAME

      - name: Deploy to test 🚀
        uses: tagus/git-deploy@v0.4.1
        with:
          changes: out
          repository: ${{ secrets.DEPLOY_REPO }}
          ssh_key: ${{ secrets.CI_KEY }}
          name: arekve
          email: asbjorn@savvy.no
          clean_repo: true